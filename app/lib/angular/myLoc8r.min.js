(function(){angular.module("myLoc8rApp",["ngRoute","ngSanitize"]);function t(t,e){t.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/locations",{templateUrl:"locations/locations.view.html",controller:"locationsCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"/about/about.view.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/location/:locationid",{templateUrl:"/locationDetail/locationDetail.view.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/addreview/:locationid",{templateUrl:"/addReview/addReview.view.html",controller:"addReviewCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"/auth/register/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"/auth/login/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});e.html5Mode(true)}angular.module("myLoc8rApp").config(["$routeProvider","$locationProvider",t])})();(function(){angular.module("myLoc8rApp").controller("homeCtrl",t);function t(){var t=this}})();(function(){angular.module("myLoc8rApp").controller("locationsCtrl",t);t.$inject=["$scope","$filter","$window","myLoc8rData","geolocation","mapHelpers"];function t(a,r,i,l,t,c){var s=this;s.showSpinner=true;s.showLocations=false;var u=function(t,e,n){s.message=t.length>0?"":"No locations found near you";var o=[];t.forEach(function(t){t.facilities.split(",").forEach(function(t){o.push(t)});t.facilities=t.facilities.split(",");t.distance=t.dist_calc;t.num_reviews=t.reviews.length;var e=t.reviews.sort(function(t,e){return t.rating-e.rating}).at(-1);t.review_summary='"'+e.review_text.split(" ").slice(0,7).join(" ")+'..."';t.is_open=r("isOpenNow")(t.openingTimes)});o=new Set(o);o=Array.from(o);o.sort(function(t,e){t=t.charCodeAt(0);e=e.charCodeAt(0);var n=t-e;return n});facility_filters=new Array;o.forEach(function(t){facility_filters.push({value:t,model:"checkbox"+t.split(" ").join(""),id:"idCheckbox"+t.split(" ").join("")})});s.facilityFiltersData=facility_filters;s.facilitiesFilters=new Array;s.data={locations:t};s.total_locations=t.length};s.filterChange=function(t,e){if(t){s.facilitiesFilters.push(e)}else{s.facilitiesFilters=new Array;s.facilityFiltersData.forEach(function(t){if(t.model==true){s.facilitiesFilters.push(t.value)}})}var n=r("facilitiesFilter")(s.data.locations,s.facilitiesFilters);c.updateMap(s.map,n)};s.clearFilters=function(){s.facilityFiltersData.forEach(function(t){t.model=false});s.facilitiesFilters=new Array;var t=r("facilitiesFilter")(s.data.locations,s.facilitiesFilters);c.updateMap(s.map,t)};var f=function(t){t.forEach(function(t){t.bearing=c.getBearing(0,0,t.lng,t.lat)});return t};var m=function(t,n,o){t.forEach(function(t){var e=c.getEndpoint(o,n,t.bearing,t.dist_calc);t.lng=e[0];t.lat=e[1]});return t};s.getData=function(t){s.message="Searching for nearby places";s.showLocations=false;s.showSpinner=true;var n=t.coords.latitude;var o=t.coords.longitude;s.lat=n;s.lng=o;if(i.sessionStorage["myLoc8r-locations"]==null){l.apiLocationByCoords(0,0).success(function(t){console.log("getting data from api");var e=f(t.data);e=m(e,o,n);i.sessionStorage["myLoc8r-locations"]=JSON.stringify(e);i.sessionStorage["myLoc8r-mapKey"]=JSON.stringify(t.map_key);u(e);s.map=c.createMap(s.data.locations,o,n,2.6,t.map_key);if(s.data.locations.length>0){s.showSpinner=false;s.showLocations=true}else{s.message="Oh no! We could not find any locations near you. Please try again later :(";s.showSpinner=false}}).error(function(t){s.message="Sorry, something's gone wrong. Please try again.";s.showSpinner=false;console.log(t)})}else{console.log("getting data from session");var e=JSON.parse(i.sessionStorage["myLoc8r-locations"]);const r=JSON.parse(i.sessionStorage["myLoc8r-mapKey"]);e=m(e,o,n);u(e);if(s.data.locations.length>0){a.$apply(function(){s.showSpinner=false;s.showLocations=true})}s.map=c.createMap(s.data.locations,o,n,2.6,r)}};s.showError=function(t){a.$apply(function(){s.message=t.message;s.showSpinner=false})};s.noGeo=function(){a.$apply(function(){s.message="Geolocation not supported by this browser";s.showSpinner=false})};t.getPosition(s.getData,s.showError,s.noGeo)}})();(function(){angular.module("myLoc8rApp").controller("locationDetailCtrl",t);t.$inject=["$routeParams","$window","myLoc8rData","$location","authentication","mapHelpers"];function t(t,e,n,o,r,a){var i=this;i.locationid=t.locationid;i.isLoggedIn=r.isLoggedIn();i.currentPath="/"+t.locationid+"?lng="+t.lng+"&lat="+t.lat+"&dist="+t.dist;var l=JSON.parse(e.sessionStorage["myLoc8r-locations"]);const c=JSON.parse(e.sessionStorage["myLoc8r-mapKey"]);let s=l.find(t=>t._id===i.locationid);s.facilities=s.facilities.split(",");s.reviews.forEach(function(t){t.authorShort=t.author.split(" ")[0]+" "+t.author.split(" ")[1][0];t.moment=moment(t.created_on).fromNow();t.created_on=new Date(t.created_on)});i.data={location:s};i.pageHeader={title:i.data.location.name};var u=Math.ceil(t.dist*10)/10;i.map=a.createMap([i.data.location],t.lng,t.lat,u,c)}})();(function(){angular.module("myLoc8rApp").controller("aboutCtrl",t);function t(){var t=this;t.pageHeader={title:"About myLoc8r"};t.main={content:"Loc8r was created to help people find places to sit down and get a bit of work done.\n\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc sed lorem ac nisi dignissim accumsan. Nullam sit amet interdum magna. Morbi quis faucibus nisi. Vestibulum mollis purus quis eros adipiscing tristique. Proin posuere semper tellus, id placerat augue dapibus ornare. Aenean leo metus, tempus in nisl eget, accumsan interdum dui. Pellentesque sollicitudin volutpat ullamcorper.\n\nSuspendisse tincidunt, lectus non suscipit pharetra, purus ipsum vehicula sapien, a volutpat mauris ligula vel dui. Proin varius interdum elit, eu porttitor quam consequat et. Quisque vitae felis sed ante fringilla fermentum in vitae sem. Quisque fermentum metus at neque sagittis imperdiet. Phasellus non laoreet massa, eu laoreet nibh. Pellentesque vel magna vulputate, porta augue vel, dapibus nisl. Phasellus aliquet nibh nec nunc posuere fringilla. Quisque sit amet dignissim erat. Nulla facilisi. Donec in sollicitudin ante. Cras rhoncus accumsan rutrum. Sed aliquet ligula dui, eget laoreet turpis tempor vitae."}}})();(function(){angular.module("myLoc8rApp").controller("registerCtrl",t);t.$inject=["$location","authentication"];function t(t,e){var n=this;n.pageHeader={title:"Create a new Loc8r account"};n.credentials={name:"",email:"",password:""};n.returnPage=t.search().page||"/";n.onSubmit=function(){n.formError="";if(!n.credentials.name||!n.credentials.email||!n.credentials.password){n.formError="All fields required, please try again";return false}else{n.doRegister()}};n.doRegister=function(){n.formError="";e.register(n.credentials).error(function(t){n.formError=t}).then(function(){t.search("page",null);t.path(n.returnPage)})}}})();(function(){angular.module("myLoc8rApp").controller("loginCtrl",t);t.$inject=["$location","authentication"];function t(t,e){var n=this;n.pageHeader={title:"Sign in to myLoc8r"};n.credentials={email:"",password:""};n.returnPage=t.search().page||"/";n.onSubmit=function(){n.formError="";if(!n.credentials.email||!n.credentials.password){n.formError="All fields required, please try again";return false}else{n.doLogin()}};n.doLogin=function(){n.formError="";e.login(n.credentials).error(function(t){n.formError=t}).then(function(){t.search("page",null);t.path(n.returnPage)})}}})();(function(){angular.module("myLoc8rApp").controller("addReviewCtrl",t);t.$inject=["$routeParams","myLoc8rData","authentication","$window"];function t(t,n,e,o){var r=this;r.isLoggedIn=e.isLoggedIn();r.currentPath="/"+t.locationid+"?lng="+t.lng+"&lat="+t.lat+"&dist="+t.dist;r.formData={rating:5,name:null,reviewText:null};r.pageHeader={title:"Add Review"};n.locationById(t.locationid).success(function(t){r.data={location:t.data}}).error(function(t){console.log(t)});r.onSubmit=function(){r.formError="";if(!r.formData.rating||!r.formData.reviewText){r.formError="All fields required, please try again";return false}else{r.formData.name=e.currentUser().name;r.doAddReview(t.locationid,r.formData);r.gotoLocation();return false}};r.gotoLocation=function(){o.location.href="/location"+r.currentPath};r.doAddReview=function(t,e){n.addReviewById(t,{author:e.name,rating:e.rating,reviewText:e.reviewText}).success(function(t){console.log("Form Submit success!");console.log(t)}).error(function(t){r.formError="Your review has not been saved, try again!";console.log("Form Submit Error!");console.log(t)});return false}}})();(function(){angular.module("myLoc8rApp").service("myLoc8rData",t);t.$inject=["$http","$window","authentication","mapHelpers"];function t(n,a,o,i){var l=function(t,e){return n.get("/api/locations?lng="+e+"&lat="+t+"&maxDistance=5")};var c=function(t){t.forEach(function(t){t.bearing=i.getBearing(0,0,t.lng,t.lat)});return t};var s=function(){return JSON.parse(a.localStorage["myLoc8r-currentLocation"])};var t=function(t,e){a.localStorage["myLoc8r-currentLocation"]=JSON.stringify([t,e])};var e=function(){var t=JSON.parse(a.localStorage["myLoc8r-locations"]);return t};var u=function(t){a.localStorage["myLoc8r-locations"]=JSON.stringify(t)};var f=function(t,n,o){t.forEach(function(t){var e=i.getEndpoint(o,n,t.bearing,t.dist_calc);t.lng=e[0];t.lat=e[1]});return t};var r=function(t,e,n){var o=s();var r=i.getDistance(o[0],o[1],t,e);return r<=n};var m=function(o,r,t=false){let e=new Promise(function(n,e){if(t||a.localStorage["myLoc8r-locations"]==null){l(0,0).success(function(t){console.log("data.data instanceof Array = "+(t.data instanceof Array));var e=c(t.data);e=f(e,r,o);u(e);n(e)}).error(function(t){console.log("error = "+t);e(t)})}});return e};var d=function(){return a.localStorage["myLoc8r-mapKey"]};var p=function(t){return n.get("/api/locations/"+t)};var g=function(t,e){o.currentUser();return n.post("/api/locations/"+t+"/reviews",e,{headers:{Authorization:"Bearer "+o.getToken(),username:o.getToken(),password:null}})};return{locationByCoords:m,locationById:p,addReviewById:g,getMapKey:d,apiLocationByCoords:l}}})();(function(){angular.module("myLoc8rApp").service("geolocation",t);function t(){var t=function(t,e,n){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(t,e)}else{n()}};return{getPosition:t}}})();(function(){angular.module("myLoc8rApp").service("authentication",t);t.$inject=["$window","$http"];function t(n,e){var t=function(t){console.log("register user = "+t);return e.post("api/register",t).success(function(t){console.log("success data: "+t);a(t.token)})};var o=function(t){return e.post("api/login",t).success(function(t){a(t.token)})};var r=function(){console.log("logout()");n.localStorage.removeItem("myLoc8r-token")};var a=function(t){n.localStorage["myLoc8r-token"]=t};var i=function(){return n.localStorage["myLoc8r-token"]};var l=function(){var t=i();if(t){var e=JSON.parse(n.atob(t.split(".")[1]));return e.exp>Date.now()/1e3}else{return false}};var c=function(){if(l()){var t=i();var e=JSON.parse(n.atob(t.split(".")[1]));console.log(JSON.stringify(e));return{email:e.email,name:e.name}}};return{saveToken:a,getToken:i,register:t,login:o,logout:r,isLoggedIn:l,currentUser:c}}})();(function(){angular.module("myLoc8rApp").service("mapHelpers",t);function t(){var c=function(t){return t*Math.PI/180};var s=function(t){return t*180/Math.PI};var l=function(t,e,n,o){var r=6371;var a=c(n);var t=c(t);var e=c(e);var i=Math.asin(Math.sin(t)*Math.cos(o/r)+Math.cos(t)*Math.sin(o/r)*Math.cos(a));var l=e+Math.atan2(Math.sin(a)*Math.sin(o/r)*Math.cos(t),Math.cos(o/r)-Math.sin(t)*Math.sin(i));var i=s(i);var l=s(l);return[l,i]};var t=function(t,e,n,o){const r=6371;const a=e*Math.PI/180;const i=o*Math.PI/180;const l=(o-e)*Math.PI/180;const c=(n-t)*Math.PI/180;const s=Math.sin(l/2)*Math.sin(l/2)+Math.cos(a)*Math.cos(i)*Math.sin(c/2)*Math.sin(c/2);const u=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));const f=r*u;return f};var e=function(t,e,n,o){const r=e*Math.PI/180;const a=t*Math.PI/180;const i=o*Math.PI/180;const l=n*Math.PI/180;const c=Math.sin(l-a)*Math.cos(i);const s=Math.cos(r)*Math.sin(i)-Math.sin(r)*Math.cos(i)*Math.cos(l-a);const u=Math.atan2(c,s);const f=(u*180/Math.PI+360)%360;return f};var u=function(t,e,n){var o=l(e,t,270,n);var r=l(e,t,90,n);var a=l(e,t,0,n);var i=l(e,t,180,n);southwestCorner=[r[0],i[1]];northeastCorner=[o[0],a[1]];return[southwestCorner,northeastCorner]};var f=function(t){var e=new Array;t.forEach(function(t){e.push({type:"Feature",properties:{description:"<strong>"+t.name+"</strong><p>"+t.address+"</p>"},geometry:{type:"Point",coordinates:[t.lng,t.lat]}})});return e};var n=function(t,e){t.removeLayer("locations");t.removeSource("locations");t.addSource("locations",{type:"geojson",data:{type:"FeatureCollection",features:f(e)}});t.addLayer({id:"locations",type:"circle",source:"locations",paint:{"circle-color":"#4264fb","circle-radius":6,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})};var o=function(t,e,n,o,r){mapboxgl.accessToken=r;const a=new mapboxgl.Map({container:"map-locations",style:"mapbox://styles/mapbox/streets-v12",center:[e,n]});a.fitBounds(u(e,n,o));const i=new mapboxgl.Marker({color:"red",scale:.5}).setLngLat([e,n]).addTo(a);a.on("load",function(){a.addSource("locations",{type:"geojson",data:{type:"FeatureCollection",features:f(t)}});a.addLayer({id:"locations",type:"circle",source:"locations",paint:{"circle-color":"#4264fb","circle-radius":6,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}});const o=new mapboxgl.Popup({closeButton:false,closeOnClick:false});a.on("mouseenter","locations",t=>{a.getCanvas().style.cursor="pointer";const e=t.features[0].geometry.coordinates.slice();const n=t.features[0].properties.description;while(Math.abs(t.lngLat.lng-e[0])>180){e[0]+=t.lngLat.lng>e[0]?360:-360}o.setLngLat(e).setHTML(n).addTo(a)});a.on("mouseleave","locations",()=>{a.getCanvas().style.cursor="";o.remove()});a.on("render",function(){a.resize()})});return a};return{createMap:o,updateMap:n,getEndpoint:l,getDistance:t,getBearing:e}}})();(function(){angular.module("myLoc8rApp").directive("ratingStars",t);function t(){return{restrict:"EA",scope:{thisRating:"=rating"},templateUrl:"/common/directives/ratingStars/rating-stars.template.html"}}})();(function(){angular.module("myLoc8rApp").directive("footerGeneric",t);function t(){return{restrict:"EA",templateUrl:"/common/directives/footerGeneric/footerGeneric.template.html"}}})();(function(){angular.module("myLoc8rApp").directive("navigation",t);function t(){return{restrict:"EA",templateUrl:"/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("myLoc8rApp").controller("navigationCtrl",t);t.$inject=["$location","authentication"];function t(t,e){var n=this;n.currentPath=t.path();n.isLoggedIn=e.isLoggedIn();n.currentUser=e.currentUser();n.logout=function(){e.logout();t.path("/");n.isLoggedIn=e.isLoggedIn()}}})();(function(){angular.module("myLoc8rApp").directive("pageHeader",t);function t(){return{restrict:"EA",scope:{content:"=content"},templateUrl:"/common/directives/pageHeader/pageHeader.template.html"}}})();(function(){angular.module("myLoc8rApp").directive("locationData",t);function t(){return{restrict:"EA",scope:{location:"=location",currentLat:"=",currentLng:"="},templateUrl:"/common/directives/locationData/locationData.template.html"}}})();(function(){angular.module("myLoc8rApp").filter("formatDistance",t);function t(){var o=function(t){return!isNaN(parseFloat(t))&&isFinite(t)};return function(t){var e,n;if(t&&o(t)){if(t>1){e=parseFloat(t).toFixed(1);n="km"}else{e=parseInt(t*1e3,10);n="m"}return e+n}else{return"?"}}}})();(function(){angular.module("myLoc8rApp").filter("addHtmlLineBreaks",t);function t(){return function(t){var e=t.replace(/\n/g,"<br/>");return e}}})();(function(){angular.module("myLoc8rApp").filter("isRating",t);function t(){return function(t){if(!isNaN(t)){var e=parseInt(t);if(e>=1&&e<=5){return true}else{return false}}else{return false}}}})();(function(){angular.module("myLoc8rApp").filter("isOpenNow",t);function t(){var c=function(e){var t=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];var n=t.findIndex(function(t){return t==e})+1;return n};var s=function(t){var e=parseInt(t.split(":")[0]);var n=parseInt(t.split(":")[1].slice(0,2));if(t.includes("pm")){e+=12}var o=new Date;o.setHours(e);o.setMinutes(n);o.setSeconds(0);o.setMilliseconds(0);return o};return function(t){var a=false;var i=false;var l=new Date;t.forEach(function(t){if(t.days.includes(" - ")){var e=c(t.days.split(" - ")[0]);var n=c(t.days.split(" - ")[1]);if(e<=l.getDay()&&l.getDay()<=n){i=true}}else{if(c(t.days)==l.getDay()){i=true}}if(i){if(!t.closed){var o=s(t.opening);var r=s(t.closing);if(o<=l&&l<=r){a=true}}}});return a}}})();(function(){angular.module("myLoc8rApp").filter("facilitiesFilter",t);function t(){var a=function(t,e){var n=new Array;t.forEach(function(t){if(t.facilities.includes(e)){n.push(t)}});return n};return function(o,t){if(Array.isArray(o)&&Array.isArray(t)){if(t.length>0){var r=null;t.forEach(function(t,e,n){if(e==0){r=a(o,t)}else{r=a(r,t)}});return r}else{return o}}}}})();